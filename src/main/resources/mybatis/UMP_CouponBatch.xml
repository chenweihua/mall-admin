<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="CouponBatch" >

  <resultMap id="BaseResultMap" type="com.mall.admin.vo.ump.CouponBatch" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 29 16:20:34 CST 2015.
    -->
   <id column="batch_id" jdbcType="BIGINT" property="batchId" />
    <result column="batch_name" jdbcType="VARCHAR" property="batchName" />
    <result column="platform_type" jdbcType="TINYINT" property="platformType" />
    <result column="used_money" jdbcType="BIGINT" property="usedMoney" />
    <result column="total_money" jdbcType="BIGINT" property="totalMoney" />
    <result column="used_number" jdbcType="INTEGER" property="usedNumber" />
    <result column="total_number" jdbcType="INTEGER" property="totalNumber" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="ps_id" jdbcType="BIGINT" property="psId" />
    <result column="feature" jdbcType="VARCHAR" property="feature" />
    <result column="creator" jdbcType="INTEGER" property="creator" />
    <result column="editor" jdbcType="INTEGER" property="editor" />
    <result column="batch_desc" jdbcType="VARCHAR" property="batchDesc" />
    <result column="deliver_type" jdbcType="VARCHAR" property="deliverType" />
    <result column="money" jdbcType="BIGINT" property="money" />
     <result column="batch_type" jdbcType="INTEGER" property="batchType" />
     <result column="activity_id" jdbcType="BIGINT" property="activityId" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:46:00 CST 2015.
    -->
    batch_id, batch_name, platform_type, used_money, total_money, used_number, total_number, 
    create_time, update_time, start_time, end_time, status, ps_id, feature, creator, 
    editor, batch_desc, deliver_type, money,batch_type,activity_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:46:00 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from tb_coupon_batch
    where batch_id = #{batchId,jdbcType=BIGINT}
  </select>
  <select id="getCouponBatchList" parameterType="hashmap" resultMap="BaseResultMap">
   select * from tb_coupon_batch where 1=1 
    <if test="startTime != null">
    	and end_time &gt;= #{startTime}
    </if>
    <!-- <if test="endTime != null">
    	and end_time &lt;=#{endTime} or end_time &gt;=#{endTime}
    </if> -->
    <if test="batchId != null">
    	and batch_id = #{batchId}
    </if>
    <if test="platformType != null">
    	and platform_type = #{platformType}
    </if>
    <if test="deliverType != null">
    	and deliver_type = #{deliverType}
    </if>
    <if test="status != null">
    <choose>
    <!-- 领取中包括两个状态 -->
    	<when test="status==2">
    	and status in (2,5)
    	</when>
    	<otherwise>
    	and status = #{status}
    	</otherwise>
    </choose>
    	
    </if>
    <if test="batchName != null">
    	and batch_name like #{batchName}
    </if>
    <if test="money != null">
    	and money = #{money}
    </if>
    order by create_time desc
    <if test="start != null and numPerPage != null" >
    	limit #{start},#{numPerPage}
    </if>
  </select> 
  
  <select id="getCountCouponBatchList" parameterType="hashmap" resultType="int">
   select count(batch_id) from tb_coupon_batch where 1=1
    <if test="startTime != null">
    	and end_time &gt;= #{startTime}
    </if>
    <!-- <if test="endTime != null">
    	and end_time &lt;=#{endTime}
    </if> -->
    <if test="batchId != null">
    	and batch_id = #{batchId}
    </if>
    <if test="platformType != null">
    	and platform_type = #{platformType}
    </if>
    <if test="deliverType != null">
    	and deliver_type = #{deliverType}
    </if>
    <if test="status != null">
    	<choose>
    <!-- 领取中包括两个状态 -->
    	<when test="status==2">
    	and status in (2,5)
    	</when>
    	<otherwise>
    	and status = #{status}
    	</otherwise>
    </choose>
    </if>
    <if test="batchName != null">
    	and batch_name like #{batchName}
    </if>
    <if test="money != null">
    	and money = #{money}
    </if>
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:46:00 CST 2015.
    -->
    delete from tb_coupon_batch
    where batch_id = #{batchId,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="CouponBatch">
    insert into tb_coupon_batch
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="batchId != null">
        batch_id,
      </if>
      <if test="batchName != null">
        batch_name,
      </if>
      <if test="platformType != null">
        platform_type,
      </if>
      <if test="usedMoney != null">
        used_money,
      </if>
      <if test="totalMoney != null">
        total_money,
      </if>
      <if test="usedNumber != null">
        used_number,
      </if>
      <if test="totalNumber != null">
        total_number,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="startTime != null">
        start_time,
      </if>
      <if test="endTime != null">
        end_time,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="psId != null">
        ps_id,
      </if>
      <if test="feature != null">
        feature,
      </if>
      <if test="creator != null">
        creator,
      </if>
      <if test="editor != null">
        editor,
      </if>
      <if test="batchDesc != null">
        batch_desc,
      </if>
      <if test="deliverType != null">
        deliver_type,
      </if>
      <if test="money != null">
        money,
      </if>
      <if test="batchType != null">
    	batch_type,
    </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="batchId != null">
        #{batchId,jdbcType=BIGINT},
      </if>
      <if test="batchName != null">
        #{batchName,jdbcType=VARCHAR},
      </if>
      <if test="platformType != null">
        #{platformType,jdbcType=TINYINT},
      </if>
      <if test="usedMoney != null">
        #{usedMoney,jdbcType=BIGINT},
      </if>
      <if test="totalMoney != null">
        #{totalMoney,jdbcType=BIGINT},
      </if>
      <if test="usedNumber != null">
        #{usedNumber,jdbcType=INTEGER},
      </if>
      <if test="totalNumber != null">
        #{totalNumber,jdbcType=INTEGER},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="startTime != null">
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        #{status,jdbcType=TINYINT},
      </if>
      <if test="psId != null">
        #{psId,jdbcType=BIGINT},
      </if>
      <if test="feature != null">
        #{feature,jdbcType=VARCHAR},
      </if>
      <if test="creator != null">
        #{creator,jdbcType=INTEGER},
      </if>
      <if test="editor != null">
        #{editor,jdbcType=INTEGER},
      </if>
      <if test="batchDesc != null">
        #{batchDesc,jdbcType=VARCHAR},
      </if>
      <if test="deliverType != null">
        #{deliverType,jdbcType=VARCHAR},
      </if>
       <if test="money != null">
        #{money,jdbcType=BIGINT},
      </if>
      <if test="batchType != null">
    	#{batchType,jdbcType=INTEGER},
    </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKey" parameterType="CouponBatch">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:46:00 CST 2015.
    -->
    update tb_coupon_batch
    <set>
      <if test="batchName != null">
        batch_name = #{batchName,jdbcType=VARCHAR},
      </if>
      <if test="platformType != null">
        platform_type = #{platformType,jdbcType=TINYINT},
      </if>
      <if test="usedMoney != null">
        used_money = #{usedMoney,jdbcType=BIGINT},
      </if>
      <if test="totalMoney != null">
        total_money = #{totalMoney,jdbcType=BIGINT},
      </if>
      <if test="usedNumber != null">
        used_number = #{usedNumber,jdbcType=INTEGER},
      </if>
      <if test="totalNumber != null">
        total_number = #{totalNumber,jdbcType=INTEGER},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="startTime != null">
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=TINYINT},
      </if>
      <if test="psId != null">
        ps_id = #{psId,jdbcType=BIGINT},
      </if>
      <if test="feature != null">
        feature = #{feature,jdbcType=VARCHAR},
      </if>
      <if test="creator != null">
        creator = #{creator,jdbcType=INTEGER},
      </if>
      <if test="editor != null">
        editor = #{editor,jdbcType=INTEGER},
      </if>
      <if test="batchDesc != null">
        batch_desc = #{batchDesc,jdbcType=VARCHAR},
      </if>
      <if test="deliverType != null">
        deliver_type = #{deliverType,jdbcType=VARCHAR},
      </if>
      <if test="money != null">
        money = #{money,jdbcType=BIGINT},
      </if>
      <if test="batchType != null">
        batch_type = #{batchType,jdbcType=INTEGER},
      </if>
      <if test="activityId != null">
        activity_id = #{activityId,jdbcType=BIGINT},
      </if>
    </set>
    where batch_id = #{batchId,jdbcType=BIGINT}
  </update>
  
  <update id="updateCouponBatchStatus" parameterType="CouponBatch" >
  	 update tb_coupon_batch t set t.status = #{status} where t.status = #{originStatus} and t.batch_id = #{batchId}
  </update>
  
 <update id="endCouponBatch" parameterType="map" >
  	 update tb_coupon_batch t set t.status = #{status} where t.batch_id = #{couponBatchId}
  </update>
  
  <update id="minusOneCouponBatch" parameterType="CouponBatch">
  	 update tb_coupon_batch t 
  	 set t.used_money = #{usedMoney},t.used_number =#{usedNumber},t.status=#{status}
  	 where t.batch_id = #{batchId}
  </update>
  
  
   <!-- <update id="minusOneCouponBatchValidStatus" parameterType="java.lang.Long">
  	 update tb_coupon_batch t set t.status = 3 where t.batch_id = ${value} and t.used_number = t.total_number
  </update> -->
  
  <update id="clearCouponBatchActivityId" parameterType="java.lang.Long">
  	 update tb_coupon_batch t set t.activity_id = 0 where t.activity_id = ${value}
  </update>
  
  
   <update id="lockCouponBatchByActiveSend" parameterType="java.lang.Long">
  	 update tb_coupon_batch t set t.status = 5 where t.activity_id = 0 and t.status = 1 and t.batch_id = ${value}
  </update>
  
  
  <update id="lockCouponBatchActivity" parameterType="java.util.Map">
  	 update tb_coupon_batch t set t.activity_id = #{activityId} where t.activity_id = 0 and t.batch_id = #{couponBatchId} and t.status = 1
  </update>
  
</mapper>