<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="CouponDetail" >
  <resultMap id="BaseResultMap" type="com.mall.admin.vo.ump.CouponDetail" >
     <id column="coupon_detail_id" jdbcType="BIGINT" property="couponDetailId" />
    <result column="coupon_type" jdbcType="TINYINT" property="couponType" />
    <result column="coupon_name" jdbcType="VARCHAR" property="couponName" />
    <result column="money" jdbcType="BIGINT" property="money" />
    <result column="amount" jdbcType="BIGINT" property="amount" />
    <result column="source" jdbcType="TINYINT" property="source" />
    <result column="business_id" jdbcType="BIGINT" property="businessId" />
    <result column="real_name" jdbcType="VARCHAR" property="realName" />
    <result column="release_business_id" jdbcType="BIGINT" property="releaseBusinessId" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="batch_id" jdbcType="BIGINT" property="batchId" />
    <result column="feature" jdbcType="VARCHAR" property="feature" />
  </resultMap>
  <resultMap id="RewardsMap" type="com.mall.admin.vo.ump.CouponRewardsInfo" >
    <id column="coupon_detail_id" jdbcType="BIGINT" property="couponDetailId" />
    <result column="source" jdbcType="TINYINT" property="source" />
    <result column="business_id" jdbcType="BIGINT" property="businessId" />
    <result column="release_business_id" jdbcType="BIGINT" property="releaseBusinessId" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="batch_id" jdbcType="BIGINT" property="batchId" />
  </resultMap>
 <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    coupon_detail_id, coupon_type, coupon_name, money, amount, source, business_id, real_name, 
    release_business_id, status, create_time, update_time, start_time, end_time, batch_id, 
    feature
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from tb_coupon_detail
    where coupon_detail_id = #{couponDetailId,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    delete from tb_coupon_detail
    where coupon_detail_id = #{couponDetailId,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="CouponDetail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    insert into tb_coupon_detail (coupon_detail_id, coupon_type, coupon_name, 
      money, amount, source, 
      business_id, real_name, release_business_id, 
      status, create_time, update_time, 
      start_time, end_time, batch_id, 
      feature)
    values (#{couponDetailId,jdbcType=BIGINT}, #{couponType,jdbcType=TINYINT}, #{couponName,jdbcType=VARCHAR}, 
      #{money,jdbcType=BIGINT}, #{amount,jdbcType=BIGINT}, #{source,jdbcType=TINYINT}, 
      #{businessId,jdbcType=BIGINT}, #{realName,jdbcType=VARCHAR}, #{releaseBusinessId,jdbcType=BIGINT}, 
      #{status,jdbcType=TINYINT}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}, 
      #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, #{batchId,jdbcType=BIGINT}, 
      #{feature,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="CouponDetail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    insert into tb_coupon_detail
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="couponDetailId != null">
        coupon_detail_id,
      </if>
      <if test="couponType != null">
        coupon_type,
      </if>
      <if test="couponName != null">
        coupon_name,
      </if>
      <if test="money != null">
        money,
      </if>
      <if test="amount != null">
        amount,
      </if>
      <if test="source != null">
        source,
      </if>
      <if test="businessId != null">
        business_id,
      </if>
      <if test="realName != null">
        real_name,
      </if>
      <if test="releaseBusinessId != null">
        release_business_id,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="startTime != null">
        start_time,
      </if>
      <if test="endTime != null">
        end_time,
      </if>
      <if test="batchId != null">
        batch_id,
      </if>
      <if test="feature != null">
        feature,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="couponDetailId != null">
        #{couponDetailId,jdbcType=BIGINT},
      </if>
      <if test="couponType != null">
        #{couponType,jdbcType=TINYINT},
      </if>
      <if test="couponName != null">
        #{couponName,jdbcType=VARCHAR},
      </if>
      <if test="money != null">
        #{money,jdbcType=BIGINT},
      </if>
      <if test="amount != null">
        #{amount,jdbcType=BIGINT},
      </if>
      <if test="source != null">
        #{source,jdbcType=TINYINT},
      </if>
      <if test="businessId != null">
        #{businessId,jdbcType=BIGINT},
      </if>
      <if test="realName != null">
        #{realName,jdbcType=VARCHAR},
      </if>
      <if test="releaseBusinessId != null">
        #{releaseBusinessId,jdbcType=BIGINT},
      </if>
      <if test="status != null">
        #{status,jdbcType=TINYINT},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="startTime != null">
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="batchId != null">
        #{batchId,jdbcType=BIGINT},
      </if>
      <if test="feature != null">
        #{feature,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="CouponDetail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    update tb_coupon_detail
    <set>
      <if test="couponType != null">
        coupon_type = #{couponType,jdbcType=TINYINT},
      </if>
      <if test="couponName != null">
        coupon_name = #{couponName,jdbcType=VARCHAR},
      </if>
      <if test="money != null">
        money = #{money,jdbcType=BIGINT},
      </if>
      <if test="amount != null">
        amount = #{amount,jdbcType=BIGINT},
      </if>
      <if test="source != null">
        source = #{source,jdbcType=TINYINT},
      </if>
      <if test="businessId != null">
        business_id = #{businessId,jdbcType=BIGINT},
      </if>
      <if test="realName != null">
        real_name = #{realName,jdbcType=VARCHAR},
      </if>
      <if test="releaseBusinessId != null">
        release_business_id = #{releaseBusinessId,jdbcType=BIGINT},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=TINYINT},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="startTime != null">
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="batchId != null">
        batch_id = #{batchId,jdbcType=BIGINT},
      </if>
      <if test="feature != null">
        feature = #{feature,jdbcType=VARCHAR},
      </if>
    </set>
    where coupon_detail_id = #{couponDetailId,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="CouponDetail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 30 19:45:37 CST 2015.
    -->
    update tb_coupon_detail
    set coupon_type = #{couponType,jdbcType=TINYINT},
      coupon_name = #{couponName,jdbcType=VARCHAR},
      money = #{money,jdbcType=BIGINT},
      amount = #{amount,jdbcType=BIGINT},
      source = #{source,jdbcType=TINYINT},
      business_id = #{businessId,jdbcType=BIGINT},
      real_name = #{realName,jdbcType=VARCHAR},
      release_business_id = #{releaseBusinessId,jdbcType=BIGINT},
      status = #{status,jdbcType=TINYINT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      start_time = #{startTime,jdbcType=TIMESTAMP},
      end_time = #{endTime,jdbcType=TIMESTAMP},
      batch_id = #{batchId,jdbcType=BIGINT},
      feature = #{feature,jdbcType=VARCHAR}
    where coupon_detail_id = #{couponDetailId,jdbcType=BIGINT}
  </update>
  
  <update id="updateAUserIdWhenNull" parameterType="java.util.Map" >
  	update tb_coupon_detail set business_id = #userId# where coupon_detail_id in (
  		select min(t.coupon_detail_id) from tb_coupon_detail t where t.business_id is null and t.batch_id = #couponBatchId# group by t.money
  	)
  
  </update>
   <select id="getCouponRewardsInfo" parameterType="hashmap" resultMap="RewardsMap">
   select m.* from 
   (select t.coupon_detail_id, t.batch_id,t.release_business_id,t.business_id,t.create_time,
   case t.status WHEN 4 then 1 else  t.status  end as `status` ,t.source 
   from tb_coupon_detail t where 1=1 
   	<if test="source !=null">
  	 and source =#{source}
   	</if>
    <if test="startTime != null">
    	and create_time &gt;= #{startTime}
    </if>
    <if test="endTime != null">
    	and create_time &lt;=#{endTime} 
    </if>
   	<if test="userId != null">
       and release_business_id = #{userId,jdbcType=BIGINT}
     </if>
  	)m
  	 ORDER BY m.release_business_id,m.status desc
    <if test="start != null and numPerPage != null" >
    	limit #{start},#{numPerPage}
    </if>
  </select> 
  
  
  <select id="getCouponRewardsInfoCount" parameterType="hashmap" resultType="int">
   select count(t.coupon_detail_id) 
   from tb_coupon_detail t where 1=1
   	<if test="source !=null">
  	 and source =#{source}
   	</if>
    <if test="startTime != null">
    	and create_time &gt;= #{startTime}
    </if>
    <if test="endTime != null">
    	and create_time &lt;=#{endTime} 
    </if>
    <if test="userId != null">
       and release_business_id = #{userId,jdbcType=BIGINT}
     </if>
  </select>
  
</mapper>